name: Deploy dev

on:
  push:
    branches: [ develop, bugfix/** ]
  pull_request:
    branches: [ develop ]

permissions:
  id-token: write   # This is required for requesting the JWT
  contents: read    # This is required for actions/checkout
  packages: read    # This is required for installing dependencies

jobs:
  test:
    name: Test develop
    uses: lomeone/github-action/.github/workflows/gradle-test.yaml@main
    secrets: inherit

  build:
    environment: dev
    name: JIB Build
    needs: [test]
    uses: lomeone/github-action/.github/workflows/gradle-module-jib.yaml@main
    with:
      module-name: application
    secrets: inherit

  deploy:
    name: Deploy dev
    runs-on: ubuntu-latest
    needs: [build]
    environment: dev

    steps:
      - name: Checkout my code
        uses: actions/checkout@v4

      - name: Add env value
        run: |
          echo "COMMIT_SHA=$(git rev-parse --short HEAD)" >> $GITHUB_ENV
          echo "branch=$(echo ${GITHUB_REF#refs/heads/})" >> $GITHUB_ENV
          echo "tag_branch=$(echo ${GITHUB_REF#refs/heads/} | sed 's/\//-/g')" >> $GITHUB_ENV

#      - name: Configure AWS Credential
#        uses: aws-actions/configure-aws-credentials@v4
#        with:
#          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
#          aws-region: ${{ secrets.AWS_REGION }}
#
#      - name: Deploy to develop in PR
#        if: ${{ github.event_name == 'pull_request' }}
#        uses: bitovi/github-actions-deploy-eks-helm@v1.2.10
#        with:
#          aws-region: ${{ secrets.AWS_REGION }}
#          cluster-name: ${{ secrets.EKS_CLUSTER_NAME }}
#          config-files: helm-chart-springboot/values.yaml,helm-chart-springboot/dev-values.yaml
#          chart-path: helm-chart-springboot/
#          namespace: ${{ secrets.EKS_NAMESPACE }}
#          values: image.tag=${{ env.COMMIT_SHA }},ingress.hosts.hots=${{ env.COMMIT_SHA }}-dev-server.lomeone.com
#          name: ${{ env.COMMIT_SHA }}-dev-lomeone-server
#
#      - name: Deploy to develop
#        if: ${{ github.event_name == 'push' && env.branch == 'develop' }}
#        uses: bitovi/github-actions-deploy-eks-helm@v1.2.10
#        with:
#          aws-region: ${{ secrets.AWS_REGION }}
#          cluster-name: ${{ secrets.EKS_CLUSTER_NAME }}
#          config-files: helm-chart-springboot/values.yaml,helm-chart-springboot/dev-values.yaml
#          chart-path: helm-chart-springboot/
#          namespace: ${{ secrets.EKS_NAMESPACE }}
#          name: dev-lomeone-server
#
#      - name: Deploy to bugfix
#        if: ${{ github.event_name == 'push' && startsWith(env.branch,'bugfix/') }}
#        uses: bitovi/github-actions-deploy-eks-helm@v1.2.10
#        with:
#          aws-region: ${{ secrets.AWS_REGION }}
#          cluster-name: ${{ secrets.EKS_CLUSTER_NAME }}
#          config-files: helm-chart-springboot/values.yaml,helm-chart-springboot/dev-values.yaml
#          chart-path: helm-chart-springboot/
#          namespace: ${{ secrets.EKS_NAMESPACE }}
#          values: image.tag=${{ env.tag_branch }},ingress.hosts.hots=${{ env.tag_branch }}-dev-server.lomeone.com
#          name: ${{ env.tag_branch }}-dev-lomeone-server
